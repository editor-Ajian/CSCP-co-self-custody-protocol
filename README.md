# CSCP：一种联合自主保管协议

本文旨在提出一种协议，利用比特币脚本的特性来实现一种可称为 “联合自主保管（co-self-custody）” 的装置；这种装置可以帮助用户消除私钥的单点故障，对抗私钥 失盗/丢失 的风险；同时，协议的存在可以消除对联合托管方的信任，联合托管方无法要挟用户。

这样的协议既可以产生一种付费的联合托管方的竞争市场，也可以在私人朋友间使用。对个人而言，这套协议将改善其自主保管比特币的体验，降低其心智负担。

## 一. 自主保管体验的痛点

当前，用户如需自主保管比特币，可以依靠的钱包大体上可以分为两类：（1）单签名钱包，即单个私钥可以控制的钱包；（2）多签名钱包，即需要多个私钥才能控制的钱包；一般来说，这种钱包还带有阈值：使用 n 个公钥生成钱包之后，只需其中 m 个私钥，就可以移动资金。

在单签名钱包中，用户只需备份单个种子词（seed words，用于推导出私钥的秘密数据，一般为 12 个或 24 个有序的英文词组），这是非常便利的。但是，它却面临着单点故障：一旦签名设备和种子词一起丢失，资金就不可能再复原；一旦种子词（或者没有口令保护的签名设备）遭到泄露或窃取，资金也会被他人转走、不可能再复原。

带有阈值的多签名钱包则消除了单签名钱包所面临的单点故障：由于 n 个公钥中只需 m 个即可控制资金，（n-m）个私钥的 失盗/丢失 都不会影响资金的安全性。用户可以在发觉 失盗/丢失 之后及时转移资金。但是，这也意味着用户需要保存多套种子词。

关于种子词的保管，有一些推荐的做法是这样的：

- 多个备份。形成多个备份以应对备份 损坏/丢失 的风险；最好使用不同的 设备/材质。
- 空间上分散。不应把这些备份都放在同一个地方，以免它们一起暴露。
- 保证空间的安全性。确保除了你本人和可靠的人，无人能触及这些保存助记词备份的地方。
- 使用可靠的材质以应对意外。这样的意外包括但不限于：水患、火灾、虫蛀、电池漏液 ……
- 加密备份。避免直接曝光。

显然，安全性是一个相对的概念，它几乎总有优化的空间。但许多人都意识到了，有一种负担鲜少被这些 “最佳习惯手册” 提及，就是 “心智负担”。假设一个人真的遵照了这样的最佳习惯手册，则他需要为备份安排安全的保存地点、选择合适的材质、安排加密方法并定期回忆解密口令 …… 这是非常头疼的。而且，如果你需要保存多套种子词，其中的复杂性就会成倍放大。

我们是否有方法，可以降低这部分负担、提高用户的保管装置的健壮性，同时不牺牲免信任性？答案是肯定的。

## 二. 模块

我们需要以下的技术模块来创建一种免信任的联合自主托管装置：

1. 比特币脚本（多路径花费）：比特币脚本允许我们设置并行的多种花费路径，比如，我们可以为同一笔资金设置三条花费路径：一条路径是一个单签名钱包；另一条路径是一个多签名钱包；还有一条是另一个多签名钱包。这是一切的基础，它使我们能够将单签名钱包和多签名钱包融合起来。
   
   - 我们还可以在一些路径中放置时间锁，使这些路径无法在资金存入的一刻就启用。
   - 比特币于 2021 年激活的 Taproot 升级为这样的多路径花费提供了更好的支持，它将路径的数量与装置的经济性解耦：转移资金所需支付的手续费几乎仅与使用了具体哪条路径有关，而与路径的多少无关。可以说，在理想的状态下，本协议的用户应该使用 P2TR 输出，它的经济性和隐私性都更好；但如果缺乏工具来创建这样的输出，使用 P2WSH 输出也可以实现绝大部分特性。

2. 主公钥以及公钥描述符：BIP39 种子词可以生成一个主私钥，该主私钥有一个对应的主公钥；这一对密钥可根据 BIP32 的规则派生出无数的密钥对。这意味着，联合保管方只需公开一个主公钥，用户就可以自行派生出许多的公钥。

   - 这样的派生在我们的协议中有两个作用：（1）让用户可以产生许多不同的地址，以遵循比特币使用的最佳习惯之一：避免地址复用；（2）在需要联合保管方协助转移资金的时候，不会暴露正在使用某个保管方。
   - 同时，由于主公钥可以推导出无数个公钥，我们需要把用于推导的信息，叫做 “派生路径” 也记录下来。这就是公钥描述符（descriptors）的作用，它可以把主公钥和派生路径记录在一起
   - 派生路径应该遵循 BIP32 的要求。

3. Miniscript 及脚本描述符：究其本源，Miniscript 的作用是根据我们想要的花费条件，生成可用的比特币脚本。而在我们这个协议中，它们的作用是备份 “脚本/地址” —— 既可以把它理解成解锁一笔资金的具体条件（要用到哪几个公钥），也可以理解为存放资金的位置。

4. PSBT（部分签名的比特币交易）：这是一种数据格式，用于传输信息，让一个签名设备可以签名一笔交易。当我们需要为一笔交易提供多个签名，而签名私钥并不存放在一个地方时，就需要 PSBT 这样的技术，以顺利获得各个签名。

总结一下，我们的思路是，制作一个多路径花费的钱包（这里暂命名为 “复合钱包”），设置一个只有我们自己能控制的路径（称为 “主路径”）和 一个/多个 使用联合保管方的路径（称为 “联合保管路径”）。那么，联合保管方就可以帮助我们对抗主路径中的私钥丢失风险。

例如，我们可以生成这样一种复合钱包：

```
主路径：2-of-2 多签名，用户电脑公钥，用户手机公钥
联合保管路径 1：2-of-3 多签名，用户电脑公钥，用户手机公钥，联合保管方 A 公钥
联合保管路径 2：2-of-3 多签名，用户电脑公钥，用户手机公钥，联合保管方 B 公钥
```

使用这样的钱包，如果用户弄丢了手机及其种子词备份，就可以联系联合保管方 A 或 B 请求复原资金。在这里，无论 A 还是 B，都无法独自转移用户的资金；而用户也可以对抗电脑私钥、手机私钥任一私钥的丢失和失盗风险。单个路径内的资金安全模式并没有改变，但是，它轻松地实现了一些最佳习惯所希望达成的效果，比如：空间分散，联合托管方的私钥跟用户的私钥几乎不可能处于同一个空间。

而脚本之外的多种技术，主要是为了保证用户可以预先安排使用联合托管方、可以记忆资金存放的位置，以及，在有需要的时候，能够获得联合托管方的签名、转移资金。

> 备注：
> 
> 1. 如果主路径使用的是单签名钱包，则无法对抗该私钥的失盗风险，但依然可以对抗该私钥的 丢失/损毁 风险；
> 2. 如果使用了 P2TR 输出，可以做到在联系 A 或 B 寻求帮助时，他们无法知道彼此的存在；但使用 P2WSH 输出则不行，因为脚本的内容将全部曝光给联合保管方，即使该保管方不知道用户使用的另一个保管方是谁，至少也将知道用户还使用了一个别的联合保管方。
> 3. 截至本文撰写之时， Miniscript 还未支持 P2TR。

## 三. 协议流程

我们用一个例子来说明这套协议的流程。我们使用 “U” 来代表一个用户，用 “A” 来代表一个联合保管方。

### 初始化流程

1. 联合保管方 A 公开自己的主公钥 PK-A 。
2. A 在一个可以接收消息的信道中，公开一个端口来接收加密的用户资料；另一个端口用来接收用户的资金转移请求。
   - A 还需要公开的信息有：（1）收费安排，即提供一次签名所需收取的费用，可以是一个比例，但设置了数额上限；（2）所支持的比特币软件钱包；（3）是否允许跟其它联合托管商一起使用；（4）所使用的文件加解密软件及算法；（5）所支持的身份验证手段（如：邮箱、公钥签名、滚动码验证器）；（6）包含了上述信息的用户信息格式文档，用户须在其中填入有用的信息。
   - 接收资料的端口应该带有一个收费机制，比如比特币收费或者闪电网络收费，以阻遏 DoS 攻击。这也是收费安排的一部分。
3. 用户 U 取得 PK-A，选择一个派生路径，然后使用 A 所支持的比特币软件钱包生成一个（包含 PK-A 的）复合钱包，并备份其描述符。
4. U 将钱包描述符、身份验证手段（比如自己的邮箱）填入格式文档，使用 A 所支持的软件加密该文档，然后生成加密文档的哈希值并保存。
5. U 访问 A 的文件接收端口，完成支付后上传加密的文档。

### 协助取款流程

1. U 向 A 发起联合取款请求，提供加密文档的哈希值，以及解密密钥。
2. A 解密该文档，要求 U 使用文档中指定的身份认证方式发送认证信息。
3. U 发送身份认证信息，以及转移资金的交易的 PSBT；该交易必须为 PK-A 所生成的另一个地址提供符合收费安排的资金。
4. A 检查 U 的认证信息，如能通过检查，则检查转移资金的交易是否提供了相应的服务费；如果还能通过，则回传对该交易的签名。任一检查不通过，就终止协助取款流程，并回传错误码。

## 四. 延伸

如你所见，这份协议，本质上是一份让用户可以将某个公开的公钥放在自己的钱包中的协议；只要这里的保管方 A 愿意，就可以提供更为丰富的功能。例如，假设 A 是一个合同仲裁者，也可以用相同的方式公开自己的公钥以及收费安排；而 U1-U2 就可以把 PK-A 放在自己的多签名合约中，作为仲裁者，在他们发生争执的时候，可以向 A 提交资料，并请求 A 的仲裁。

同理，朋友之间，也可以使用这个协议，形成一个联合保管钱包。由于朋友可以面对面验证，上述许多验证环节都可以简化。

形成协议之后，支持这样的协议的服务商就形成了一种可以比较和定价的服务，从而允许竞争市场的出现；同时，实现这样的协议也允许熟人之间形成合作式的联合保管，相当于达成了多签名钱包的一种最佳习惯 —— 私钥备份的地理分散。

